---
phase: 03-context-injection
plan: 05
type: execute
wave: 2
depends_on: [03-03, 03-04]
files_modified: [src/plugin.ts, src/index.ts]
autonomous: true

must_haves:
  truths:
    - "session.created handler loads and injects context"
    - "session.compacting handler performs custom compaction"
    - "Context injected into system message via SDK"
    - "No modifySystemPrompt API - use message-based injection"
    - "Error handling prevents plugin crashes"
  artifacts:
    - path: "src/plugin.ts"
      provides: "Updated plugin with context injection"
      exports: ["OpencodeBrainPlugin", "createPlugin"]
      contains: ["session.compacting", "loadAndInjectContext"]
    - path: "src/index.ts"
      provides: "Plugin exports (may need updates)"
  key_links:
    - from: "src/plugin.ts::session.created"
      to: "src/context/injection.ts::loadAndInjectContext"
      via: "import and call"
      pattern: "loadAndInjectContext\\(storage"
    - from: "src/plugin.ts::session.compacting"
      to: "src/context/compacting.ts::handleSessionCompacting"
      via: "import and call"
      pattern: "handleSessionCompacting"
---

<objective>
Wire context injection and compacting into the plugin event handlers (INJ-01, INJ-05, INJ-06).

Purpose: This is the integration plan that connects all the context modules to the actual SDK event handlers in plugin.ts. It implements the session.created injection and session.compacting handler.

Output: Updated plugin.ts with working context injection and compacting.
</objective>

<execution_context>
@/Users/buddythacat/.config/opencode/get-shit-done/workflows/execute-plan.md
@/Users/buddythacat/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@src/plugin.ts
@src/context/injection.ts
@src/context/compacting.ts
@src/context/selection.ts
@src/context/formatting.ts
@src/storage/sqlite-storage.ts
@src/types.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update plugin.ts with context injection</name>
  <files>src/plugin.ts</files>
  <action>
    Update src/plugin.ts to add context injection:
    
    1. Add imports at top:
       ```typescript
       import { loadAndInjectContext, createSystemMessageWithContext } from "./context/injection.js";
       import { handleSessionCompacting } from "./context/compacting.js";
       ```
    
    2. Update session.created handler (currently has stub comment):
       - After `currentSessionId = session.id;`
       - Call loadAndInjectContext:
         ```typescript
         const injectionResult = loadAndInjectContext(storage, {
           agentType: 'build', // Will be enhanced in 03-06
           maxObservations: config.maxContextObservations,
           maxTokens: config.maxContextTokens,
           debug: config.debug,
         });
         ```
       - If debug mode: log injection stats
       - Store injectionResult in a module-level variable for later use
       - Note: Actual SDK injection will use message-based approach (no modifySystemPrompt API available per RESEARCH.md)
    
    3. Add session.compacting handler:
       ```typescript
       "session.compacting": async (input: { observations: Observation[] }) => {
         if (config.debug) {
           client.app.log({ message: `[opencode-brain] Session compacting triggered` });
         }
         
         try {
           const compacted = handleSessionCompacting(input.observations, {
             mode: config.autoCompress ? "conservative" : "aggressive",
             targetTokenCount: Math.floor(config.maxContextTokens / 2),
           });
           
           return { observations: compacted };
         } catch (error) {
           console.error("[opencode-brain] Compacting failed:", error);
           return { observations: input.observations }; // Return original on error
         }
       },
       ```
    
    4. Add at top of return object (before session.created):
       ```typescript
     // Store last injection result for reference
     let lastInjectionResult: ContextInjectionResult | null = null;
       ```
    
    5. Ensure graceful error handling in all handlers:
       - Wrap injection call in try/catch
       - On error: log and continue (don't crash session)
       - Never throw from event handlers
    
    6. Verify TypeScript types:
       - ContextInjectionResult type import
       - Observation type import
       - All parameters typed correctly
    
    7. Preserve all existing functionality:
       - Keep tool.execute.after handler
       - Keep file.edited handler
       - Keep session.deleted handler
       - Keep onError handler
  </action>
  <verify>
    npx tsc --noEmit src/plugin.ts
  </verify>
  <done>
    TypeScript compiles without errors, session.compacting handler present
  </done>
</task>

<task type="auto">
  <name>Task 2: Add context exports to index.ts if needed</name>
  <files>src/index.ts</files>
  <action>
    Check and update src/index.ts:
    
    1. Read current src/index.ts content
    
    2. Ensure exports are complete:
       - export { OpencodeBrainPlugin, createPlugin } from "./plugin.js";
       - Keep existing exports
       - Add context module exports if they should be public:
         ```typescript
         export { loadAndInjectContext } from "./context/injection.js";
         export { selectRelevantContext } from "./context/selection.js";
         export { formatContextForInjection } from "./context/formatting.js";
         export { handleSessionCompacting } from "./context/compacting.js";
         ```
    
    3. Only export what external users need. Internal modules may stay unexported.
    
    4. Verify TypeScript compilation.
  </action>
  <verify>
    npx tsc --noEmit src/index.ts
  </verify>
  <done>
    All exports present, TypeScript compiles
  </done>
</task>

<task type="auto">
  <name>Task 3: Verify full integration test</name>
  <files>src/plugin.ts, src/context/injection.ts, src/context/compacting.ts</files>
  <action>
    Create integration verification:
    
    1. Check that all imports resolve:
       ```bash
       npx tsc --noEmit
       ```
    
    2. Verify no circular dependencies:
       - context/ → storage/ (✓ existing)
       - context/ → types (✓ existing)
       - plugin.ts → context/ (✓ new)
       - context/ → plugin/ (✗ should not exist)
    
    3. Run all existing tests to ensure no regressions:
       ```bash
       npm test
       ```
    
    4. Verify bundle builds successfully:
       ```bash
       npm run build
       ```
  </action>
  <verify>
    npm run build && npm test
  </verify>
  <done>
    Build succeeds, all 195+ tests pass
  </done>
</task>

</tasks>

<verification>
1. TypeScript compiles: `npx tsc --noEmit`
2. Build succeeds: `npm run build`
3. All tests pass: `npm test` (195/195)
4. session.compacting handler present in plugin.ts
5. No circular dependencies introduced
</verification>

<success_criteria>
- [ ] session.created calls loadAndInjectContext()
- [ ] session.compacting handler added and calls handleSessionCompacting()
- [ ] All context module imports resolve correctly
- [ ] TypeScript compiles without errors
- [ ] Build succeeds (npm run build)
- [ ] All existing tests pass (195/195)
- [ ] No regressions in Phase 1-2 functionality
- [ ] Graceful error handling in all new handlers
</success_criteria>

<output>
After completion, create `.planning/phases/03-context-injection/03-05-SUMMARY.md`
</output>
