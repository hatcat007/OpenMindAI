---
phase: 03-context-injection
plan: 02
type: execute
wave: 1
depends_on: []
files_modified: [src/context/formatting.ts, src/context/formatting.test.ts]
autonomous: true

must_haves:
  truths:
    - "Context is formatted with stylish ANSI colors and Unicode borders"
    - "Four sections: Previous Context, Key Decisions, Recent Changes, Open Issues"
    - "Empty state shows welcome message for first sessions"
    - "Format respects token limits and compresses if needed"
  artifacts:
    - path: "src/context/formatting.ts"
      provides: "Context formatting with stylish presentation"
      exports: ["formatContextForInjection", "estimateTokenCount", "CompressionMode"]
    - path: "src/context/formatting.test.ts"
      provides: "Unit tests for formatting"
      contains: ["ANSI color codes", "Unicode box-drawing"]
  key_links:
    - from: "src/context/formatting.ts"
      to: "src/types.ts::InjectedContext"
      via: "type import"
      pattern: "import.*InjectedContext"
    - from: "formatContextForInjection"
      to: "estimateTokenCount"
      via: "token validation before output"
      pattern: "estimateTokenCount.*maxContextTokens"
---

<objective>
Create stylish context formatting module that presents injected context beautifully (INJ-02).

Purpose: The context injection must be visually appealing with ANSI colors, Unicode borders, and emoji headers as specified in CONTEXT.md. It should feel premium and professional.

Output: Working formatting module that produces beautiful context strings ready for system message injection.
</objective>

<execution_context>
@/Users/buddythacat/.config/opencode/get-shit-done/workflows/execute-plan.md
@/Users/buddythacat/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@src/types.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create formatting module with ANSI styling</name>
  <files>src/context/formatting.ts</files>
  <action>
    Create src/context/formatting.ts with:
    
    1. ANSI color constants (purple/blue gradient theme):
       - HEADER = "\x1b[38;5;141m" (purple)
       - SUBHEADER = "\x1b[38;5;75m" (blue)
       - BORDER = "\x1b[38;5;240m" (gray)
       - RESET = "\x1b[0m"
    
    2. Unicode box-drawing characters:
       - TOP_LEFT = "‚ï≠", TOP_RIGHT = "‚ïÆ"
       - BOTTOM_LEFT = "‚ï∞", BOTTOM_RIGHT = "‚ïØ"
       - HORIZONTAL = "‚îÄ", VERTICAL = "‚îÇ"
       - T_LEFT = "‚îú", T_RIGHT = "‚î§"
    
    3. formatContextForInjection(context, options) function:
       - Format with header: "üìã Previous Context" 
       - Section "üéØ Key Decisions": decision-type observations
       - Section "üìù Recent Changes": refactor/feature/bugfix types
       - Section "‚ö†Ô∏è Open Issues": problem/warning types
       - Use Unicode borders around each section
       - Apply ANSI colors (purple headers, blue subheaders, gray borders)
    
    4. estimateTokenCount(text): number:
       - Use 4 chars ‚âà 1 token estimation
       - Return estimated token count
    
    5. CompressionMode type: "conservative" | "aggressive"
    
    6. If context exceeds maxContextTokens:
       - Conservative: Keep most relevant, summarize rest
       - Never hard-truncate mid-sentence
    
    7. Empty state (no previous context):
       - Show: "üß† No previous context found. Starting fresh."
       - Still use stylish formatting
    
    Follow existing patterns from src/events/tool-capture.ts for structure.
    Never use external libraries for ANSI codes - pure string concatenation.
  </action>
  <verify>
    npx tsc --noEmit src/context/formatting.ts
  </verify>
  <done>
    TypeScript compiles without errors, exports all required functions
  </done>
</task>

<task type="auto">
  <name>Task 2: Create comprehensive formatting tests</name>
  <files>src/context/formatting.test.ts</files>
  <action>
    Create src/context/formatting.test.ts with tests:
    
    1. Test ANSI codes are present in output (search for \x1b patterns)
    2. Test Unicode borders are present (‚ï≠‚îÄ‚ïÆ characters)
    3. Test emoji headers present (üìã, üéØ, üìù, ‚ö†Ô∏è)
    4. Test sections are properly separated
    5. Test empty state shows welcome message
    6. Test token estimation is accurate (4 chars = 1 token)
    7. Test compression respects maxContextTokens
    8. Test no hard truncation mid-sentence
    
    Use vitest patterns from src/events/tool-capture.test.ts.
    Import { describe, it, expect } from "vitest".
  </action>
  <verify>
    npm test src/context/formatting.test.ts
  </verify>
  <done>
    All tests pass (8+ test cases)
  </done>
</task>

</tasks>

<verification>
1. TypeScript compiles: `npx tsc --noEmit`
2. Tests pass: `npm test src/context/formatting.test.ts`
3. Output contains ANSI codes and Unicode borders
4. Token estimation is accurate
</verification>

<success_criteria>
- [ ] formatContextForInjection() returns styled string with ANSI colors
- [ ] Unicode borders render correctly (‚ï≠‚îÄ‚ïÆ box drawing)
- [ ] Four sections present with correct emoji headers
- [ ] Empty state shows welcome message
- [ ] Token estimation uses 4 chars ‚âà 1 token formula
- [ ] Compression respects limits without hard truncation
- [ ] All unit tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/03-context-injection/03-02-SUMMARY.md`
</output>
