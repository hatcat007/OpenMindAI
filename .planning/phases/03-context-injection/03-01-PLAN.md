---
phase: 03-context-injection
plan: 01
type: tdd
wave: 1
depends_on: []
files_modified: [src/context/selection.ts, src/context/selection.test.ts]
autonomous: true

must_haves:
  truths:
    - "Context is selected based on relevance score not just recency"
    - "Agent type influences context selection (plan vs build)"
    - "Conservative mode keeps only high-confidence items"
    - "Aggressive mode includes more context with lower thresholds"
  artifacts:
    - path: "src/context/selection.ts"
      provides: "Smart context selection with relevance scoring"
      exports: ["selectRelevantContext", "calculateRelevanceScore", "ContextSelectionOptions"]
    - path: "src/context/selection.test.ts"
      provides: "Unit tests for selection algorithm"
      contains: ["describe('relevance scoring'", "describe('agent type weighting'"]
  key_links:
    - from: "src/context/selection.ts"
      to: "src/storage/storage-interface.ts"
      via: "MemoryEntry type import"
      pattern: "import.*MemoryEntry"
    - from: "calculateRelevanceScore"
      to: "ContextSelectionOptions.agentType"
      via: "agent match scoring (20% weight)"
      pattern: "agentMatch.*0\.2"
---

<objective>
Implement smart context selection algorithm with relevance scoring (INJ-03).

Purpose: Context injection needs to be intelligent, not just chronological. This algorithm selects the most relevant observations based on multiple weighted factors.

Output: Working selection module with TDD-verified scoring algorithm.
</objective>

<execution_context>
@/Users/buddythacat/.config/opencode/get-shit-done/workflows/execute-plan.md
@/Users/buddythacat/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@src/storage/storage-interface.ts
@src/types.ts
</context>

<feature>
  <name>Relevance Scoring Algorithm</name>
  <files>src/context/selection.ts, src/context/selection.test.ts</files>
  <behavior>
    Calculate relevance score for each observation using weighted factors:
    - Recency: 40% weight (newer = higher score, exponential decay)
    - Importance: 30% weight (by observation type: decision=1.0, problem=0.9, warning=0.8, refactor=0.7, success=0.6, discovery=0.5, feature/bugfix=0.4, pattern/solution=0.3)
    - Agent Match: 20% weight (1.0 if agentType matches, 0.0 if different)
    - Keyword Match: 10% weight (bonus for matching recent conversation keywords)
    
    Test cases:
    1. Recent observation (1 min ago) scores higher than old (1 day ago)
    2. Decision type scores higher than pattern type
    3. Same agent type gets 20% bonus vs different agent
    4. Keyword match adds bonus when content contains recent keywords
    5. Conservative mode filters below minConfidence (0.6)
    6. Aggressive mode lowers threshold to 0.3
  </behavior>
  <implementation>
    1. Create src/context/selection.ts with exports:
       - calculateRelevanceScore(entry, options): number
       - selectRelevantContext(entries[], options): MemoryEntry[]
       - ContextSelectionOptions interface
    
    2. Implement scoring formula:
       score = (recencyScore * 0.4) + (importanceScore * 0.3) + (agentMatch * 0.2) + (keywordMatch * 0.1)
       
       recencyScore = exp(-hoursAgo / 24) // 24-hour half-life
       importanceScore = typeWeights[type] || 0.3
       agentMatch = entry.metadata?.agentType === options.agentType ? 1.0 : 0.0
       keywordMatch = calculateKeywordOverlap(entry.content, recentKeywords)
    
    3. Create src/context/selection.test.ts with comprehensive tests
    
    4. Run RED-GREEN-REFACTOR cycle:
       - RED: Write failing tests
       - GREEN: Implement to pass tests
       - REFACTOR: Optimize if needed
  </implementation>
</feature>

<verification>
1. All tests pass: `npm test src/context/selection.test.ts`
2. Scoring produces expected values (tested via assertions)
3. Conservative mode excludes low-confidence items
4. Aggressive mode includes more context
</verification>

<success_criteria>
- [ ] calculateRelevanceScore() returns scores 0.0-1.0 range
- [ ] Weighted formula correctly balances all 4 factors
- [ ] Type-based importance weights match specification
- [ ] Conservative/Aggressive modes filter appropriately
- [ ] All unit tests pass (6+ test cases covering scenarios)
</success_criteria>

<output>
After completion, create `.planning/phases/03-context-injection/03-01-SUMMARY.md`
</output>
