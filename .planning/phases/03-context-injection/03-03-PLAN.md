---
phase: 03-context-injection
plan: 03
type: execute
wave: 1
depends_on: [03-01, 03-02]
files_modified: [src/context/injection.ts, src/context/injection.test.ts]
autonomous: true

must_haves:
  truths:
    - "Context is loaded from storage at session.created event"
    - "Loading indicator shown if loading takes >500ms"
    - "Context injected into system message (not user message)"
    - "Injection delay <100ms acceptable"
    - "First user message has access to injected context"
  artifacts:
    - path: "src/context/injection.ts"
      provides: "Context loading and injection logic"
      exports: ["loadAndInjectContext", "ContextInjectionResult"]
    - path: "src/context/injection.test.ts"
      provides: "Unit tests for injection flow"
  key_links:
    - from: "src/context/injection.ts"
      to: "src/context/selection.ts"
      via: "import selectRelevantContext"
      pattern: "import.*selectRelevantContext"
    - from: "src/context/injection.ts"
      to: "src/context/formatting.ts"
      via: "import formatContextForInjection"
      pattern: "import.*formatContextForInjection"
    - from: "loadAndInjectContext"
      to: "storage.search()"
      via: "query recent observations"
      pattern: "storage\.search\\("
---

<objective>
Implement context loading and injection logic for session.created event (INJ-01, INJ-02, INJ-05).

Purpose: This is the core injection mechanism that loads relevant memories from storage, formats them, and injects into the system message when a session starts.

Output: Working injection module that handles loading indicator, timing requirements, and SDK message injection.
</objective>

<execution_context>
@/Users/buddythacat/.config/opencode/get-shit-done/workflows/execute-plan.md
@/Users/buddythacat/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@src/context/selection.ts
@src/context/formatting.ts
@src/storage/storage-interface.ts
@src/storage/sqlite-storage.ts
@src/types.ts
@src/plugin.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create context injection module</name>
  <files>src/context/injection.ts</files>
  <action>
    Create src/context/injection.ts with:
    
    1. ContextInjectionResult interface:
       - context: string (formatted context ready for injection)
       - observationCount: number
       - tokenCount: number
       - loadTimeMs: number
       - isFirstSession: boolean
    
    2. loadAndInjectContext(storage, options) function:
       - Parameters:
         - storage: StorageInterface (from sqlite-storage.ts)
         - options: { agentType: 'plan' | 'build', maxObservations: number, maxTokens: number, debug: boolean }
       
       - Flow:
         1. Record startTime
         2. Query storage for recent observations (last 30 days)
         3. If no observations found â†’ return first-session welcome
         4. Call selectRelevantContext() to score and filter
         5. Call formatContextForInjection() to format
         6. Calculate loadTimeMs
         7. If loadTimeMs > 500ms and debug mode â†’ log "ðŸ§  Loading memory..."
         8. Return ContextInjectionResult
       
       - Error handling:
         - Wrap all storage calls in try/catch
         - On error: return empty context with isFirstSession: true
         - Never throw - graceful degradation
    
    3. createSystemMessageWithContext(originalPrompt, context) function:
       - Prepend formatted context to original system prompt
       - Add separator line between context and original
       - Return combined system message
    
    4. Import dependencies:
       - import { selectRelevantContext } from "./selection.js"
       - import { formatContextForInjection } from "./formatting.js"
       - import type { StorageInterface } from "../storage/storage-interface.js"
       - import type { Observation } from "../types.js"
    
    5. Ensure <100ms target for injection (measured in tests)
  </action>
  <verify>
    npx tsc --noEmit src/context/injection.ts
  </verify>
  <done>
    TypeScript compiles without errors, all exports present
  </done>
</task>

<task type="auto">
  <name>Task 2: Create injection tests with timing validation</name>
  <files>src/context/injection.test.ts</files>
  <action>
    Create src/context/injection.test.ts with tests:
    
    1. Test successful context loading:
       - Mock storage with sample observations
       - Verify context is returned
       - Verify observationCount matches
    
    2. Test first session (no memories):
       - Mock storage with empty results
       - Verify isFirstSession: true
       - Verify welcome message in context
    
    3. Test timing requirements:
       - Verify load completes in <100ms (use performance.now())
       - Test slow loading (>500ms) triggers loading indicator logic
    
    4. Test error handling:
       - Mock storage to throw error
       - Verify graceful return (no throw)
       - Verify isFirstSession: true on error
    
    5. Test system message creation:
       - Verify context prepended to original prompt
       - Verify separator present
    
    6. Test integration with selection:
       - Verify selectRelevantContext is called with correct options
    
    7. Test integration with formatting:
       - Verify formatContextForInjection is called
    
    Use mock storage implementing StorageInterface for testing.
    Follow patterns from src/storage/sqlite-storage.test.ts.
  </action>
  <verify>
    npm test src/context/injection.test.ts
  </verify>
  <done>
    All tests pass (7+ test cases), timing tests verify <100ms requirement
  </done>
</task>

</tasks>

<verification>
1. TypeScript compiles: `npx tsc --noEmit`
2. Tests pass: `npm test src/context/injection.test.ts`
3. Timing test verifies <100ms injection time
4. Integration with 03-01 (selection) and 03-02 (formatting) works
</verification>

<success_criteria>
- [ ] loadAndInjectContext() loads memories from storage
- [ ] selectRelevantContext() called with correct agentType
- [ ] formatContextForInjection() called with selected observations
- [ ] Loading indicator logic present for >500ms loads
- [ ] Injection completes in <100ms (measured)
- [ ] First session detected and welcome message shown
- [ ] Graceful error handling (no throws)
- [ ] All unit tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/03-context-injection/03-03-SUMMARY.md`
</output>
