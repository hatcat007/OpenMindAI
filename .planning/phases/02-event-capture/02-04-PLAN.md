---
phase: 02-event-capture
plan: 04
type: execute
wave: 2
depends_on: ["02-01", "02-02"]
files_modified:
  - src/events/file-capture.ts
  - src/events/file-capture.test.ts
  - src/events/error-capture.ts
  - src/plugin.ts
  - src/index.ts
autonomous: true
must_haves:
  truths:
    - File edits are captured with metadata
    - .env and sensitive files are excluded
    - Session errors are captured for debugging
    - All capture functions exported for external use
    - Integration tests verify end-to-end flow
  artifacts:
    - path: src/events/file-capture.ts
      provides: File edit capture logic
      exports: ["captureFileEdit"]
    - path: src/events/error-capture.ts
      provides: Error event capture
      exports: ["captureSessionError"]
    - path: src/events/file-capture.test.ts
      provides: File capture tests
    - path: src/plugin.ts
      provides: Complete event capture integration
      changes: "file.edited handler implemented, onError enhanced"
  key_links:
    - from: file.edited handler
      to: shouldCaptureFile
      via: filter.ts import
      pattern: if.*shouldCaptureFile.*filePath
    - from: file.edited handler
      to: EventBuffer.add
      via: captureFileEdit function
      pattern: buffer\.add\(entry\)
---

<objective>
Implement file edit and session error capture in the plugin.

Purpose: CAPT-02 requires capturing file.edited events, CAPT-03 requires capturing session.error events. This plan completes the event capture implementation.

Output: File edit capture with exclusion logic, error capture, and complete plugin integration.
</objective>

<execution_context>
@/Users/buddythacat/.config/opencode/get-shit-done/workflows/execute-plan.md
@/Users/buddythacat/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/REQUIREMENTS.md
@.planning/phases/02-event-capture/02-RESEARCH.md
@src/plugin.ts

## Current State

Plugin has stubs:
```typescript
"file.edited": async (input: { filePath: string }) => {
  if (config.debug) {
    console.log(`[opencode-brain] File edited: ${input.filePath}`);
  }
  // Stub for Phase 2
}

onError: (error: Error) => {
  console.error("[opencode-brain] Plugin error:", error.message);
  // Don't re-throw
}
```

## Dependencies (Wave 1)

- 02-01: EventBuffer class
- 02-02: Privacy filter (shouldCaptureFile)

## Integration with 02-03

This plan runs in parallel with 02-03 (both Wave 2). They share:
- Same buffer instance
- Same storage
- Both update plugin.ts (different handlers)

File ownership note: 02-03 owns the buffer creation and tool.execute.after handler. 
This plan owns file.edited and onError handlers.
</context>

<tasks>

<task type="auto">
  <name>Create file capture module</name>
  <files>src/events/file-capture.ts</files>
  <action>
Create src/events/file-capture.ts with file edit capture logic:

1. Imports:
   - import { MemoryEntry } from "../storage/storage-interface.js";
   - import { EventBuffer } from "./buffer.js";
   - import { shouldCaptureFile } from "../privacy/filter.js";
   - import { ObservationType } from "../types.js";

2. Interface FileEditInput:
   - filePath: string

3. captureFileEdit(input: FileEditInput, buffer: EventBuffer, sessionId: string): boolean:
   - Check shouldCaptureFile(input.filePath):
     - If false, return false (skip logging to avoid noise)
   - Create MemoryEntry:
     - id: crypto.randomUUID()
     - type: "refactor" (edits are refactoring)
     - content: `File modified: ${input.filePath}`
     - createdAt: Date.now()
     - metadata: {
         sessionId,
         summary: `Edited ${input.filePath.split('/').pop()}`,
         files: [input.filePath],
       }
   - Add to buffer: buffer.add(entry)
   - Return true if captured, false if skipped
   - Error handling: try/catch, log error, return false, never throw

4. Export captureFileEdit function
  </action>
  <verify>
npm run typecheck passes
  </verify>
  <done>
File capture module created with exclusion logic
  </done>
</task>

<task type="auto">
  <name>Create error capture module</name>
  <files>src/events/error-capture.ts</files>
  <action>
Create src/events/error-capture.ts with error event capture:

1. Imports:
   - import { MemoryEntry } from "../storage/storage-interface.js";
   - import { EventBuffer } from "./buffer.js";
   - import { ObservationType } from "../types.js";

2. captureSessionError(error: Error, buffer: EventBuffer, sessionId: string): void:
   - Check error message for sensitive patterns (reuse filter logic):
     - If error contains password/secret/token, sanitize or skip
   - Create MemoryEntry:
     - id: crypto.randomUUID()
     - type: "problem" (errors are problems)
     - content: `Session error: ${error.message}`
     - createdAt: Date.now()
     - metadata: {
         sessionId,
         summary: `Error: ${error.name}`,
         error: error.name,
         // Don't include stack trace (too verbose for now)
       }
   - Add to buffer: buffer.add(entry)
   - Error handling: silent fail - if capturing fails, don't create infinite loop

3. Export captureSessionError function

Note: This is for plugin-level errors, not tool errors (which are handled in tool capture).
</action>
  <verify>
npm run typecheck passes
  </verify>
  <done>
Error capture module created
  </done>
</task>

<task type="auto">
  <name>Create file/error capture tests</name>
  <files>src/events/file-capture.test.ts</files>
  <action>
Create src/events/file-capture.test.ts with tests:

1. Setup:
   - Import { describe, it, expect } from "bun:test"
   - Import { captureFileEdit } from "./file-capture.js"
   - Import { captureSessionError } from "./error-capture.js"
   - Import { EventBuffer } from "./buffer.js"

2. captureFileEdit tests:
   - "captures regular file edit" - "src/index.ts" → buffer receives entry
   - "returns true when captured" - verify return value
   - "excludes .env file" - ".env" → returns false, buffer unchanged
   - "excludes .env.local" - ".env.local" → returns false
   - "excludes .git directory" - ".git/config" → returns false
   - "excludes secret files" - "secrets.json" → returns false
   - "excludes .key files" - "id_rsa.key" → returns false
   - "sets correct type to refactor" - verify entry.type
   - "includes session ID in metadata" - verify metadata.sessionId
   - "includes file path in metadata.files" - verify metadata.files array
   - "handles errors gracefully" - mock error condition, verify no throw

3. captureSessionError tests:
   - "captures error to buffer" - verify entry added
   - "sets type to problem" - verify entry.type === "problem"
   - "includes error name in metadata" - verify metadata.error
   - "includes error message in content" - verify entry.content
   - "handles errors gracefully" - if buffer fails, no infinite loop
   - "handles sensitive error messages" - sanitize or skip if contains secrets

4. Integration test with actual buffer:
   - "file edit flows through buffer" - add → flush → verify entry
   - "error flows through buffer" - add → flush → verify entry
  </action>
  <verify>
npx bun test src/events/file-capture.test.ts passes all tests
  </verify>
  <done>
12+ tests passing for file and error capture
  </done>
</task>

<task type="auto">
  <name>Integrate file/error capture into plugin</name>
  <files>src/plugin.ts</files>
  <action>
Update src/plugin.ts with file and error capture (coordinate with 02-03 changes):

1. Add imports (combine with 02-03 imports if both editing):
   - import { captureFileEdit } from "./events/file-capture.js";
   - import { captureSessionError } from "./events/error-capture.js";

2. Add sessionId tracking at plugin level:
   - Track current session ID from session.created
   - Use it when capturing events

3. Update "file.edited" handler:
   ```typescript
   "file.edited": async (input: { filePath: string }) => {
     if (config.debug) {
       console.log(`[opencode-brain] File edited: ${input.filePath}`);
     }
     
     try {
       const captured = captureFileEdit(input, eventBuffer, currentSessionId);
       if (config.debug && captured) {
         console.log(`[opencode-brain] Captured file edit: ${input.filePath}`);
       }
     } catch (error) {
       console.error(
         "[opencode-brain] Failed to capture file edit:",
         error instanceof Error ? error.message : String(error)
       );
     }
   },
   ```

4. Update "session.created" to track session ID:
   ```typescript
   "session.created": async ({ session }: { session: { id: string } }) => {
     currentSessionId = session.id; // Track for event capture
     if (config.debug) {
       client.app.log({
         message: `[opencode-brain] Session ${session.id} started`,
       });
     }
   },
   ```

5. Enhance onError handler:
   ```typescript
   onError: (error: Error) => {
     console.error("[opencode-brain] Plugin error:", error.message);
     
     try {
       captureSessionError(error, eventBuffer, currentSessionId);
     } catch {
       // Silent fail - don't create error loop
     }
     
     // Don't re-throw - keep Opencode running
   },
   ```

6. Add currentSessionId variable at top of plugin function:
   - let currentSessionId: string = "unknown";

7. Ensure no conflicts with 02-03 changes to plugin.ts
  </action>
  <verify>
npm run typecheck passes
  </verify>
  <done>
Plugin updated with file edit and error capture integration
  </done>
</task>

<task type="auto">
  <name>Export event capture modules</name>
  <files>src/index.ts</files>
  <action>
Update src/index.ts to export all event capture functions:

1. Add exports at end of file:
   ```typescript
   // Event capture exports
   export { EventBuffer } from "./events/buffer.js";
   export { captureToolExecution } from "./events/tool-capture.js";
   export { captureFileEdit } from "./events/file-capture.js";
   export { captureSessionError } from "./events/error-capture.js";
   ```

2. Verify existing exports remain:
   - export { OpencodeBrainPlugin, createPlugin } from "./plugin.js";
   - export type { PluginConfig } from "./config.js";
   - export { sanitizeContent, shouldCaptureFile, sanitizeBashCommand } from "./privacy/filter.js";

3. Ensure all new event modules are properly exported
  </action>
  <verify>
npm run typecheck passes
  </verify>
  <done>
All event capture modules exported from index.ts
  </done>
</task>

</tasks>

<verification>
- [ ] File capture module created with exclusion logic
- [ ] Error capture module created
- [ ] 12+ unit tests passing
- [ ] Plugin integrated with file and error capture
- [ ] Session ID tracking added
- [ ] .env files excluded from capture
- [ ] All modules exported from index.ts
- [ ] TypeScript typecheck passes
</verification>

<success_criteria>
Complete event capture system:
- Tool executions captured (from 02-03)
- File edits captured with exclusion
- Session errors captured
- All events buffered and flushed to mind.mv2
- Privacy filtering applied throughout
</success_criteria>

<output>
After completion, create `.planning/phases/02-event-capture/02-04-SUMMARY.md`
</output>
