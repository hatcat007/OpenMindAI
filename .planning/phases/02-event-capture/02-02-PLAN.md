---
phase: 02-event-capture
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/privacy/filter.ts
  - src/privacy/filter.test.ts
autonomous: true
must_haves:
  truths:
    - .env files are never captured
    - Passwords and API keys are redacted from content
    - Bash commands with auth flags are redacted
    - Git directory files are excluded
    - Secrets in file paths trigger exclusion
  artifacts:
    - path: src/privacy/filter.ts
      provides: Privacy filtering functions
      exports: ["sanitizeContent", "shouldCaptureFile", "sanitizeBashCommand"]
      min_lines: 100
    - path: src/privacy/filter.test.ts
      provides: Unit tests for privacy filtering
  key_links:
    - from: tool.execute.after handler
      to: sanitizeContent
      via: filter.ts import
      pattern: sanitizeContent\(.*content\)
---

<objective>
Implement privacy filtering to prevent sensitive data from being stored in mind.mv2.

Purpose: Requirement PRIV-02 and PRIV-03 mandate that secrets, passwords, API keys, and .env files must never appear in storage. This is a critical security/privacy feature.

Output: Privacy filter module with content sanitization and file exclusion functions.
</objective>

<execution_context>
@/Users/buddythacat/.config/opencode/get-shit-done/workflows/execute-plan.md
@/Users/buddythacat/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/REQUIREMENTS.md
@.planning/phases/02-event-capture/02-RESEARCH.md

## Requirements

- CAPT-06: Filter sensitive data (passwords, API keys, .env files)
- PRIV-02: Exclude .env files from capture
- PRIV-03: Filter bash commands with passwords

## Research Findings

Secret patterns to detect:
- password[:=]value
- api_key[:=]value
- token[:=]value
- secret[:=]value
- SSH/SSL private keys

File exclusions:
- .env files (all variations)
- .git/ directory
- *.key, *.pem, *.p12, *.pfx
- Files with "secret", "password", "credential", "token" in path

Bash redaction:
- Commands with -u or --user flags
- Commands matching secret patterns
</context>

<tasks>

<task type="auto">
  <name>Create privacy filter functions</name>
  <files>src/privacy/filter.ts</files>
  <action>
Create src/privacy/filter.ts with three main functions:

1. SENSITIVE_PATTERNS constant:
   Array of RegExp patterns for secret detection:
   - /password\s*[:=]\s*\S+/gi
   - /api[_-]?key\s*[:=]\s*\S+/gi
   - /secret\s*[:=]\s*\S+/gi
   - /token\s*[:=]\s*\S+/gi
   - /private[_-]?key\s*[:=]\s*\S+/gi
   - /-----BEGIN (RSA|EC|DSA|OPENSSH) PRIVATE KEY-----/
   - /[a-zA-Z0-9_]*password[a-zA-Z0-9_]*\s*[=:]\s*["']?[^"'\s]+["']?/gi

2. EXCLUDED_PATH_PATTERNS constant:
   Array of RegExp for file path filtering:
   - /\.env/
   - /\.env\.\w+/ (.env.local, .env.production, etc.)
   - /\.git\//
   - /\.(key|pem|p12|pfx)$/i
   - /secret/i
   - /password/i
   - /credential/i
   - /token/i
   - /private/i

3. sanitizeContent(content: string): string:
   - Iterate through SENSITIVE_PATTERNS
   - Replace matches with "[REDACTED]"
   - Return sanitized string
   - Handle null/undefined gracefully

4. shouldCaptureFile(filePath: string): boolean:
   - Check against EXCLUDED_PATH_PATTERNS
   - Return false if any pattern matches
   - Return true otherwise
   - Normalize path separators (handle Windows/Unix)

5. sanitizeBashCommand(command: string): string | null:
   - Check if command matches any SENSITIVE_PATTERNS
   - Check for auth flags: /curl.*-u\s|curl.*--user/, /ssh.*-p\s/, /mysql.*-p\s/
   - Return "[REDACTED BASH COMMAND]" if sensitive
   - Return original command if safe
   - Return null for empty commands

6. Helper: isSensitiveContent(content: string): boolean:
   - Quick check if content contains sensitive patterns
   - Used for early exit optimization

All functions must be pure (no side effects) and well-typed.
  </action>
  <verify>
npm run typecheck passes
  </verify>
  <done>
All filter functions implemented with TypeScript types
  </done>
</task>

<task type="auto">
  <name>Create privacy filter unit tests</name>
  <files>src/privacy/filter.test.ts</files>
  <action>
Create src/privacy/filter.test.ts with comprehensive tests:

1. sanitizeContent tests:
   - "redacts password: value" - "password: secret123" → "password: [REDACTED]"
   - "redacts api_key=value" - "api_key=sk-abc123" → "api_key=[REDACTED]"
   - "redacts token: value" - "token: bearer_123" → "token: [REDACTED]"
   - "redacts secret= value" - "secret= hidden" → "secret= [REDACTED]"
   - "redacts multiple secrets" - mixed content with 2+ secrets
   - "preserves safe content" - "hello world" stays unchanged
   - "handles empty string" - returns empty string
   - "handles null/undefined" - returns empty string or original

2. shouldCaptureFile tests:
   - "excludes .env file" - ".env" → false
   - "excludes .env.local" - ".env.local" → false
   - "excludes .env.production" - ".env.production" → false
   - "excludes .git directory files" - ".git/config" → false
   - "excludes .key files" - "id_rsa.key" → false
   - "excludes .pem files" - "cert.pem" → false
   - "excludes secret files" - "config/secrets.json" → false
   - "excludes password files" - "passwords.txt" → false
   - "allows regular source files" - "src/index.ts" → true
   - "allows regular config files" - "package.json" → true

3. sanitizeBashCommand tests:
   - "redacts command with password" - "curl -u user:pass ..." → "[REDACTED BASH COMMAND]"
   - "redacts curl with --user" - "curl --user admin:secret ..." → "[REDACTED BASH COMMAND]"
   - "redacts ssh with password" - "ssh user@host -p password" → "[REDACTED BASH COMMAND]"
   - "redacts mysql with -p" - "mysql -u root -p secret" → "[REDACTED BASH COMMAND]"
   - "allows safe ls command" - "ls -la" stays unchanged
   - "allows safe cat command" - "cat file.txt" stays unchanged
   - "returns null for empty command" - "" → null

4. Edge case tests:
   - "handles Windows paths" - "C:\\project\\.env" → false
   - "handles mixed case secrets" - "PASSWORD: Secret" → "PASSWORD: [REDACTED]"
   - "handles secrets in URLs" - "https://user:pass@host.com" → "https://[REDACTED]@host.com"
  </action>
  <verify>
npx bun test src/privacy/filter.test.ts passes all tests
  </verify>
  <done>
All 20+ tests passing, covering all filter functions and edge cases
  </done>
</task>

<task type="auto">
  <name>Export privacy module</name>
  <files>src/index.ts</files>
  <action>
Update src/index.ts to export privacy functions:

1. Add export statement at the end of the file:
   export { sanitizeContent, shouldCaptureFile, sanitizeBashCommand } from "./privacy/filter.js";

2. This allows external testing and validation of privacy functions

3. Keep existing exports (OpencodeBrainPlugin, createPlugin, PluginConfig)
  </action>
  <verify>
npm run typecheck passes
  </verify>
  <done>
Privacy functions exported from main index.ts
  </done>
</task>

</tasks>

<verification>
- [ ] All filter functions implemented
- [ ] 20+ unit tests passing
- [ ] .env files correctly excluded
- [ ] Passwords/API keys redacted
- [ ] Bash commands filtered
- [ ] Edge cases handled (Windows paths, case sensitivity)
- [ ] TypeScript typecheck passes
- [ ] Functions exported from index.ts
</verification>

<success_criteria>
Privacy filtering layer ready. Any content passing through these functions will be safe to store in mind.mv2 without exposing secrets.
</success_criteria>

<output>
After completion, create `.planning/phases/02-event-capture/02-02-SUMMARY.md`
</output>
