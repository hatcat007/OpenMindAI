---
phase: 01-foundation
plan: 02
type: execute
wave: 1
depends_on: []
files_modified: [
  "src/index.ts",
  "src/plugin.ts",
  "src/config.ts",
  "opencode.json"
]
autonomous: true
must_haves:
  truths:
    - "Plugin exports valid Opencode plugin function"
    - "Plugin loads without errors when Opencode starts"
    - "Auto-initializes and creates mind.mv2 on first run"
    - "Handles plugin lifecycle events (load, events, unload)"
    - "Works with Bun runtime and @opencode-ai/plugin SDK"
  artifacts:
    - path: "src/index.ts"
      provides: "Main plugin entry point"
      min_lines: 30
      exports: ["default", "OpencodeBrainPlugin"]
    - path: "src/plugin.ts"
      provides: "Plugin implementation with event handlers"
      min_lines: 100
      exports: ["createPlugin"]
    - path: "src/config.ts"
      provides: "Configuration handling and defaults"
      min_lines: 50
      exports: ["PluginConfig", "loadConfig", "getStoragePath"]
    - path: "opencode.json"
      provides: "Plugin configuration example"
      min_lines: 10
      contains: "plugin array with opencode-brain"
  key_links:
    - from: "src/index.ts"
      to: "src/plugin.ts"
      via: "imports createPlugin"
      pattern: "import.*createPlugin|from.*plugin"
    - from: "src/plugin.ts"
      to: "src/storage/sqlite-storage.ts"
      via: "imports storage layer"
      pattern: "import.*createStorage|from.*storage"
    - from: "src/config.ts"
      to: "src/plugin.ts"
      via: "provides configuration"
      pattern: "PluginConfig|loadConfig"
---

<objective>
Build the Opencode plugin architecture using @opencode-ai/plugin SDK with proper event handlers and auto-initialization.

Purpose: Plugin is the integration point with Opencode. Without proper plugin structure, Opencode cannot load or use the memory system.
Output: Complete plugin implementation that loads, initializes storage, and handles lifecycle events.
</objective>

<execution_context>
@/Users/buddythacat/.config/opencode/get-shit-done/workflows/execute-plan.md
@/Users/buddythacat/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-foundation/01-CONTEXT.md
@.planning/research/ARCHITECTURE.md â€” Section "Plugin System (RECOMMENDED)" and "Port Strategy: Native Plugin"

# Reference: Phase 1 Plan 01 (Storage Layer)
# Storage interface will be available at: src/storage/storage-interface.ts
# Storage implementation at: src/storage/sqlite-storage.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Plugin Configuration Handler</name>
  <files>src/config.ts</files>
  <action>
    Create configuration management for the plugin.
    
    Define PluginConfig interface:
    ```typescript
    interface PluginConfig {
      storagePath?: string;      // Default: ".opencode/mind.mv2"
      autoInitialize?: boolean;   // Default: true
      debug?: boolean;          // Default: false
    }
    ```
    
    Implement functions:
    1. `loadConfig(ctx: PluginContext): PluginConfig`
       - Read from ctx.config if available
       - Merge with defaults
       - Return validated config
    
    2. `getStoragePath(worktree: string, config: PluginConfig): string`
       - Resolve relative paths to absolute
       - Default to join(worktree, ".opencode/mind.mv2")
       - Ensure directory exists
    
    3. `ensureDirectory(path: string): Promise<void>`
       - Create parent directories if missing
       - Use Bun-compatible APIs (Bun.file, Bun.write)
       - Silent fail if already exists
    
    Configuration precedence:
    1. User-provided in opencode.json
    2. Environment variables (OPENCODE_BRAIN_*)
    3. Hardcoded defaults
    
    Add JSDoc comments for all exported functions.
  </action>
  <verify>
    bun check src/config.ts
    Test config loading:
    bun run -e "
    const { loadConfig, getStoragePath } = await import('./src/config.ts');
    const config = loadConfig({ config: {}, worktree: '/tmp/test' });
    console.log('Config loaded:', !!config);
    console.log('Storage path:', getStoragePath('/tmp/test', config));
    "
  </verify>
  <done>
    Configuration handler works: loads defaults, merges user config, resolves storage paths correctly
  </done>
</task>

<task type="auto">
  <name>Task 2: Create Plugin Implementation</name>
  <files>src/plugin.ts</files>
  <action>
    Create the core plugin implementation using @opencode-ai/plugin SDK.
    
    Import from @opencode-ai/plugin:
    ```typescript
    import type { Plugin, PluginContext } from "@opencode-ai/plugin";
    ```
    
    Implement createPlugin function:
    ```typescript
    export async function createPlugin(ctx: PluginContext): Promise<Plugin> {
      // Load configuration
      const config = loadConfig(ctx);
      const storagePath = getStoragePath(ctx.worktree, config);
      
      // Initialize storage (lazy or immediate based on config)
      const storage = await createStorage({
        path: storagePath,
        autoInitialize: config.autoInitialize ?? true
      });
      
      return {
        // Session start - initialize if needed
        "session.created": async () => {
          if (config.debug) {
            console.log("[opencode-brain] Session started, storage:", storagePath);
          }
        },
        
        // Tool execution - capture for future phases
        "tool.execute.after": async (input, output) => {
          // Stub for Phase 2 - just log if debug mode
          if (config.debug) {
            console.log("[opencode-brain] Tool executed:", input.tool);
          }
        },
        
        // Session end - close storage cleanly
        "session.idle": async () => {
          if (config.debug) {
            console.log("[opencode-brain] Session idle, closing storage");
          }
          await storage.close();
        },
        
        // Handle errors gracefully
        onError: (error) => {
          console.error("[opencode-brain] Plugin error:", error.message);
          // Don't re-throw - keep Opencode running
        }
      };
    }
    ```
    
    Key requirements:
    1. **Auto-initialization:** If storage file doesn't exist, create it automatically
    2. **Worktree detection:** Use ctx.worktree for project-specific storage
    3. **Error handling:** Never throw from event handlers - log and continue
    4. **Debug mode:** Optional logging for troubleshooting
    5. **Clean shutdown:** Close storage on session.idle
    
    Import storage layer from Plan 01:
    ```typescript
    import { createStorage } from "./storage/sqlite-storage.js";
    ```
    
    Add extensive JSDoc explaining the plugin lifecycle.
  </action>
  <verify>
    bun check src/plugin.ts
    TypeScript compiles without errors
  </verify>
  <done>
    Plugin implementation compiles and exports valid Opencode Plugin interface
  </done>
</task>

<task type="auto">
  <name>Task 3: Create Plugin Entry Point</name>
  <files>src/index.ts, opencode.json</files>
  <action>
    Create the main entry point for the plugin package.
    
    src/index.ts:
    ```typescript
    /**
     * Opencode Brain Plugin
     * 
     * Makes Opencode remember everything across sessions.
     * 
     * @module opencode-brain
     */
    
    import type { Plugin } from "@opencode-ai/plugin";
    import { createPlugin } from "./plugin.js";
    
    // Re-export types for users
    export type { PluginConfig } from "./config.js";
    export { createPlugin };
    
    // Default export for Opencode plugin system
    const OpencodeBrainPlugin: Plugin = async (ctx) => {
      return createPlugin(ctx);
    };
    
    export default OpencodeBrainPlugin;
    ```
    
    Create example opencode.json for documentation:
    ```json
    {
      "plugin": ["opencode-brain"],
      "opencode-brain": {
        "storagePath": ".opencode/mind.mv2",
        "autoInitialize": true,
        "debug": false
      }
    }
    ```
    
    Requirements:
    1. Default export must be a valid Plugin function
    2. Named exports for advanced users
    3. Complete JSDoc header
    4. Example configuration showing all options
    5. Follow ESM conventions (".js" extensions in imports)
    
    Also create a README section documenting installation:
    ```markdown
    ## Installation
    
    ```bash
    npm install opencode-brain
    ```
    
    Add to your `opencode.json`:
    ```json
    {
      "plugin": ["opencode-brain"]
    }
    ```
    
    The plugin auto-initializes on first run.
    ```
    ```
  </action>
  <verify>
    bun check src/index.ts
    Verify exports:
    bun run -e "
    const mod = await import('./src/index.ts');
    console.log('Default export exists:', typeof mod.default === 'function');
    console.log('Named exports:', Object.keys(mod).filter(k => k !== 'default'));
    "
  </verify>
  <done>
    Plugin entry point exports valid default Plugin function and example configuration is documented
  </done>
</task>

</tasks>

<verification>
After all tasks complete:
1. [ ] TypeScript compiles: `bun check src/index.ts src/plugin.ts src/config.ts`
2. [ ] Default export is a valid Plugin function
3. [ ] Configuration loads with sensible defaults
4. [ ] Auto-initialization creates storage file if missing
5. [ ] Event handlers are defined (even if stubbed for Phase 2)
6. [ ] Error handling doesn't throw from event handlers
</verification>

<success_criteria>
- Plugin exports valid Opencode Plugin interface
- Loads without errors when imported by Opencode
- Configuration merges defaults with user settings
- Auto-initializes storage on first run
- Handles session.created and session.idle events
- Uses Bun-compatible APIs throughout
- Silent error handling prevents Opencode crashes
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation/01-02-SUMMARY.md`

Include in SUMMARY:
- Plugin architecture decisions
- Configuration options and defaults
- Event handlers implemented
- Auto-initialization behavior
- Installation instructions
- Any deviations from planned approach
</output>
