---
phase: 01-foundation
plan: 03
type: execute
wave: 1
depends_on: []
files_modified: [
  "package.json",
  "tsconfig.json",
  "tsup.config.ts",
  ".gitignore",
  "README.md",
  "bunfig.toml"
]
autonomous: true
must_haves:
  truths:
    - "Package can be installed via npm install"
    - "Build produces valid output in dist/"
    - "TypeScript compiles without errors"
    - "Package exports work for both ESM and CommonJS consumers"
    - "Zero configuration works out of the box"
  artifacts:
    - path: "package.json"
      provides: "NPM package configuration"
      min_lines: 50
      contains: ["name: opencode-brain", "@opencode-ai/plugin", "bun:sqlite"]
    - path: "tsconfig.json"
      provides: "TypeScript compiler configuration"
      min_lines: 20
      contains: ["module: ESNext", "target: ES2022", "strict: true"]
    - path: "tsup.config.ts"
      provides: "Build configuration"
      min_lines: 20
      contains: ["format: [\"esm\"]", "@opencode-ai/plugin"]
    - path: ".gitignore"
      provides: "Git ignore patterns"
      min_lines: 10
      contains: ["node_modules", "dist", ".opencode/mind.mv2"]
    - path: "README.md"
      provides: "Installation and usage documentation"
      min_lines: 60
      contains: ["npm install opencode-brain", "opencode.json"]
  key_links:
    - from: "package.json"
      to: "tsup.config.ts"
      via: "build script references tsup"
      pattern: "tsup|build"
    - from: "package.json"
      to: "tsconfig.json"
      via: "TypeScript configuration"
      pattern: "typescript|tsc"
---

<objective>
Set up NPM package structure, build configuration, and documentation for opencode-brain.

Purpose: Without proper packaging, users cannot install the plugin. Without documentation, users cannot use it.
Output: Complete npm package ready for publishing or local installation.
</objective>

<execution_context>
@/Users/buddythacat/.config/opencode/get-shit-done/workflows/execute-plan.md
@/Users/buddythacat/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-foundation/01-CONTEXT.md
@.planning/phases/01-foundation/01-RESEARCH.md ‚Äî Bun-optimized tsconfig, bun:test

**Key Research Findings:**
- **Bun-optimized tsconfig** ‚Äî Use `module: "Preserve"`, `allowImportingTsExtensions: true`, `types: ["bun-types"]`
- **bun:test** ‚Äî Built-in Jest-compatible testing, no Jest/Vitest needed
- **bun.lock** ‚Äî Text-based (not binary), human-readable
- **ESM-only** ‚Äî Bun has excellent ESM support, no CommonJS needed

# Reference: Prior plans
# Plan 01 provides: src/storage/* ‚Äî SYNCHRONOUS storage layer using bun:sqlite
# Plan 02 provides: src/index.ts, src/plugin.ts, src/config.ts ‚Äî plugin implementation
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create NPM Package Configuration</name>
  <files>package.json, .gitignore, bunfig.toml</files>
  <action>
    Create package.json for opencode-brain NPM package.
    
    Required fields:
    ```json
    {
      "name": "opencode-brain",
      "version": "0.1.0",
      "description": "Memory persistence for Opencode - remember everything across sessions",
      "main": "dist/index.js",
      "module": "dist/index.js",
      "types": "dist/index.d.ts",
      "type": "module",
      "exports": {
        ".": {
          "import": "./dist/index.js",
          "types": "./dist/index.d.ts"
        }
      },
      "files": ["dist/", "opencode.json", "README.md"],
      "scripts": {
        "build": "tsup",
        "dev": "tsup --watch",
        "typecheck": "tsc --noEmit",
        "lint": "eslint src/",
        "test": "bun test",
        "prepublishOnly": "npm run build"
      },
      "keywords": ["opencode", "plugin", "memory", "ai", "coding"],
      "author": "Your Name",
      "license": "MIT",
      "engines": {
        "bun": ">=1.0.0"
      },
      "peerDependencies": {
        "@opencode-ai/plugin": ">=1.0.0"
      },
      "devDependencies": {
        "@types/bun": "latest",
        "typescript": "^5.7.0",
        "tsup": "^8.0.0"
      }
    }
    ```
    
    Also create .gitignore:
    ```
    node_modules/
    dist/
    .DS_Store
    *.log
    .env
    .env.local
    .opencode/mind.mv2
    .opencode/mind.mv2.lock
    .opencode/mind.mv2-shm
    .opencode/mind.mv2-wal
    coverage/
    *.tmp
    bun.lockb
    ```
    
    Create bunfig.toml for Bun configuration:
    ```toml
    [install]
    # Use text-based lockfile (human-readable)
    lockfile = "bun.lock"
    
    [test]
    # Jest-compatible test runner settings
    preload = []
    coverage = false
    ```
    
    Important notes:
    1. "type": "module" for ESM-only
    2. Bun as primary engine (not Node.js)
    3. @opencode-ai/plugin as peer dependency
    4. No @memvid/sdk (using bun:sqlite instead)
    5. Include opencode.json in published files
    6. bun.lock is text-based (Bun 1.2+), bun.lockb is binary (legacy)
  </action>
  <verify>
    Validate package.json:
    bun run -e "const pkg = await import('./package.json', { assert: { type: 'json' } }); console.log('Name:', pkg.default.name); console.log('Has test script:', pkg.default.scripts?.test === 'bun test');"
    
    Verify .gitignore exists and has key patterns:
    grep -E "(node_modules|dist|mind.mv2)" .gitignore
    
    Verify bunfig.toml exists:
    cat bunfig.toml
  </verify>
  <done>
    package.json uses bun:test; .gitignore excludes build artifacts and SQLite WAL files; bunfig.toml configured
  </done>
</task>

<task type="auto">
  <name>Task 2: Create Bun-Optimized TypeScript Configuration</name>
  <files>tsconfig.json, tsup.config.ts</files>
  <action>
    Create Bun-optimized TypeScript and build configuration.
    
    **Bun-optimized tsconfig.json:**
    ```json
    {
      "compilerOptions": {
        "target": "ESNext",
        "module": "Preserve",
        "moduleDetection": "force",
        "moduleResolution": "bundler",
        "lib": ["ESNext"],
        "strict": true,
        "esModuleInterop": true,
        "allowImportingTsExtensions": true,
        "verbatimModuleSyntax": true,
        "skipLibCheck": true,
        "forceConsistentCasingInFileNames": true,
        "declaration": true,
        "declarationMap": true,
        "sourceMap": true,
        "outDir": "./dist",
        "rootDir": "./src",
        "resolveJsonModule": true,
        "isolatedModules": true,
        "noUnusedLocals": true,
        "noUnusedParameters": true,
        "noImplicitReturns": true,
        "noFallthroughCasesInSwitch": true,
        "noUncheckedIndexedAccess": true,
        "noImplicitOverride": true,
        "types": ["bun-types"]
      },
      "include": ["src/**/*"],
      "exclude": ["node_modules", "dist"]
    }
    ```
    
    **Key Bun optimizations:**
    - `module: "Preserve"` ‚Äî Let Bun handle module resolution
    - `allowImportingTsExtensions: true` ‚Äî Import `.ts` files directly
    - `verbatimModuleSyntax: true` ‚Äî ESM imports/exports unchanged
    - `types: ["bun-types"]` ‚Äî Bun type definitions
    - `noEmit: true` implied by verbatimModuleSyntax (Bun compiles TS natively)
    
    **tsup.config.ts for npm packaging:**
    ```typescript
    import { defineConfig } from "tsup";
    
    export default defineConfig({
      entry: ["src/index.ts"],
      format: ["esm"],
      target: "esnext",
      platform: "node",
      bundle: true,
      splitting: false,
      sourcemap: true,
      clean: true,
      dts: true,
      external: [
        "@opencode-ai/plugin",  // Peer dependency
        "bun:sqlite",           // Built-in Bun module
        "bun:test"              // Built-in test module
      ],
      esbuildOptions(options) {
        options.banner = {
          js: "#!/usr/bin/env bun",
        };
      }
    });
    ```
    
    **Testing with bun:test:**
    Tests use Bun's built-in test runner (Jest-compatible):
    ```typescript
    import { test, expect, describe } from "bun:test";
    ```
    
    No need for Jest or Vitest configuration.
  </action>
  <verify>
    Validate configurations:
    bun run tsc --noEmit
    
    Verify Bun-optimized settings:
    bun run -e "
    const tsconfig = JSON.parse(await Bun.file('./tsconfig.json').text());
    console.log('Module:', tsconfig.compilerOptions.module);
    console.log('Has bun-types:', tsconfig.compilerOptions.types?.includes('bun-types'));
    console.log('Allow TS extensions:', tsconfig.compilerOptions.allowImportingTsExtensions);
    "
  </verify>
  <done>
    Bun-optimized tsconfig validates (module: Preserve, bun-types, allowImportingTsExtensions)
  </done>
</task>

<task type="auto">
  <name>Task 3: Create README and Installation Documentation</name>
  <files>README.md</files>
  <action>
    Create comprehensive README.md for opencode-brain.
    
    Structure:
    ```markdown
    # Opencode Brain

    Memory persistence for Opencode. Remember everything across sessions without user effort.

    ## Features

    - ‚ú® Automatic memory capture (tool use, file changes, errors)
    - üîç Search with `/mind search <query>`
    - üìä View statistics with `/mind stats`
    - üí¨ Natural language queries with `/mind ask`
    - üîí 100% local storage (no cloud)
    - ‚ö° Zero configuration (works out of the box)

    ## Installation

    ```bash
    npm install opencode-brain
    ```

    Add to your `opencode.json`:

    ```json
    {
      "plugin": ["opencode-brain"]
    }
    ```

    The plugin auto-initializes on first run.

    ## Commands

    - `/mind stats` ‚Äî Show memory statistics
    - `/mind search <query>` ‚Äî Search memories
    - `/mind ask <question>` ‚Äî Query with natural language
    - `/mind recent` ‚Äî Show recent sessions
    - `/mind timeline` ‚Äî View session history

    ## Configuration

    Optional configuration in `opencode.json`:

    ```json
    {
      "plugin": ["opencode-brain"],
      "opencode-brain": {
        "storagePath": ".opencode/mind.mv2",
        "autoInitialize": true,
        "debug": false
      }
    }
    ```

    ## Storage Location

    By default, memories are stored in `.opencode/mind.mv2` (SQLite format).
    This file should be added to your `.gitignore`.

    ## Privacy

    - All data stored locally in your project directory
    - No external APIs or cloud services
    - Sensitive data filtering (passwords, .env files)
    - User controls what gets captured

    ## Requirements

    - Bun >= 1.0.0
    - Opencode >= 1.0.0

    ## License

    MIT
    ```
    
    Also include sections (can be brief for now):
    - Architecture overview
    - Development setup
    - Contributing
    - Troubleshooting
    - Migration from claude-brain (Phase 4)
  </action>
  <verify>
    Verify README exists and has key sections:
    grep -E "(Installation|npm install|opencode.json|/mind stats|Features)" README.md
    
    Check for critical information:
    - Installation instructions present
    - Configuration example shown
    - Commands listed
    - Storage location documented
    - Privacy note included
  </verify>
  <done>
    README includes installation, configuration, commands, and storage documentation
  </done>
</task>

</tasks>

<verification>
After all tasks complete:
1. [ ] package.json is valid with bun engine requirement
2. [ ] tsconfig.json uses Bun-optimized settings (module: Preserve, bun-types)
3. [ ] Build configuration externalizes bun:sqlite and @opencode-ai/plugin
4. [ ] .gitignore excludes appropriate files (including .opencode/mind.mv2)
5. [ ] README documents installation and usage
6. [ ] bun:test available for testing (built-in)
7. [ ] Package can theoretically be published to npm
</verification>

<success_criteria>
- package.json has correct name, version, exports, and scripts (uses bun:test)
- TypeScript configuration uses Bun-optimized settings (module: Preserve, allowImportingTsExtensions, bun-types)
- Build configuration externalizes @opencode-ai/plugin, bun:sqlite, bun:test
- .gitignore excludes node_modules, dist, and mind.mv2 files
- README documents: installation, configuration, commands, storage, privacy
- Package structure follows npm best practices with Bun as primary engine
- Zero configuration works (no required setup beyond npm install + opencode.json)
- Uses bun:test (built-in) instead of Jest/Vitest
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation/01-03-SUMMARY.md`

Include in SUMMARY:
- Package configuration decisions
- Build toolchain choices
- Dependencies and peer dependencies
- Documentation completeness
- Any deviations from planned approach
</output>
