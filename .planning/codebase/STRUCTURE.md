# Codebase Structure

**Analysis Date:** 2026-02-03

## Directory Layout

```
smf/
├── .claude-plugin/          # Plugin metadata for Claude Code
├── .github/                 # CI/CD workflows
├── commands/                # Command documentation (markdown)
├── dist/                    # Compiled output (generated)
├── hooks/                   # Hook configuration (source)
├── skills/                  # Agent skills documentation
├── src/                     # Source code
│   ├── __tests__/          # Test files
│   ├── core/               # Core memory engine
│   ├── hooks/              # Hook implementations
│   ├── scripts/            # CLI-like scripts
│   ├── utils/              # Utility modules
│   ├── index.ts            # Public API exports
│   └── types.ts            # TypeScript type definitions
├── package.json            # Node.js package manifest
├── tsconfig.json           # TypeScript configuration
└── tsup.config.ts          # Build configuration
```

## Directory Purposes

**.claude-plugin/:**
- Purpose: Claude Code plugin registration and metadata
- Contains: `plugin.json` (name, version, author), `marketplace.json`
- Key files: `.claude-plugin/plugin.json`

**commands/:**
- Purpose: Command documentation for Claude Code command system
- Contains: Markdown files describing available commands
- Key files: `commands/ask.md`, `commands/search.md`, `commands/stats.md`, `commands/recent.md`

**dist/:**
- Purpose: Compiled JavaScript output (generated by `tsup`)
- Contains: Transpiled `.js` files, source maps, type definitions
- Generated: Yes (via `npm run build`)
- Committed: Yes (for plugin distribution)

**hooks/:**
- Purpose: Hook configuration JSON (source, copied to dist during build)
- Contains: `hooks.json` defining hook registrations
- Key files: `hooks/hooks.json` (copied to `dist/hooks/hooks.json`)

**skills/:**
- Purpose: Agent skill documentation for Cursor/Claude
- Contains: `SKILL.md` files describing agent capabilities
- Key files: `skills/memory/SKILL.md`, `skills/mind/SKILL.md`

**src/:**
- Purpose: All source code
- Contains: TypeScript source files organized by layer
- Key subdirectories:
  - `src/core/`: Core memory engine (`mind.ts`)
  - `src/hooks/`: Hook implementations (4 hooks)
  - `src/scripts/`: CLI scripts (4 scripts + utils)
  - `src/utils/`: Shared utilities (3 modules)
  - `src/__tests__/`: Test files

**src/core/:**
- Purpose: Core memory persistence engine
- Contains: `Mind` class implementation
- Key files: `src/core/mind.ts` (409 lines, main engine)

**src/hooks/:**
- Purpose: Claude Code hook implementations
- Contains: Hook scripts that respond to events
- Key files:
  - `src/hooks/session-start.ts`: Session initialization (89 lines)
  - `src/hooks/post-tool-use.ts`: Observation capture (291 lines)
  - `src/hooks/stop.ts`: Session summary generation (321 lines)
  - `src/hooks/smart-install.ts`: Dependency installation (130 lines)
  - `src/hooks/hooks.json`: Hook registration config

**src/scripts/:**
- Purpose: Standalone scripts for querying memory
- Contains: CLI-like scripts using SDK directly
- Key files:
  - `src/scripts/ask.ts`: Question answering (95 lines)
  - `src/scripts/find.ts`: Search interface
  - `src/scripts/stats.ts`: Statistics display
  - `src/scripts/timeline.ts`: Chronological view
  - `src/scripts/utils.ts`: Shared memory opening utilities (97 lines)

**src/utils/:**
- Purpose: Shared utility functions
- Contains: Cross-cutting concerns (compression, locking, helpers)
- Key files:
  - `src/utils/compression.ts`: Tool output compression (431 lines)
  - `src/utils/memvid-lock.ts`: File locking wrapper (29 lines)
  - `src/utils/helpers.ts`: General helpers (201 lines)

**src/__tests__/:**
- Purpose: Unit tests
- Contains: Test files using Vitest
- Key files: `src/__tests__/index.test.ts`, `src/__tests__/mind-lock.test.ts`

## Key File Locations

**Entry Points:**
- `src/index.ts`: Public library API exports (35 lines)
- `.claude-plugin/plugin.json`: Plugin registration
- `src/hooks/hooks.json`: Hook event registration

**Configuration:**
- `package.json`: Dependencies, scripts, package metadata
- `tsconfig.json`: TypeScript compiler settings
- `tsup.config.ts`: Build configuration (entry points, format, external deps)
- `eslint.config.js`: Linting rules

**Core Logic:**
- `src/core/mind.ts`: Main `Mind` class (409 lines)
- `src/types.ts`: TypeScript type definitions (125 lines)

**Testing:**
- `src/__tests__/`: Test files
- `vitest` configured in `package.json` scripts

## Naming Conventions

**Files:**
- Kebab-case for hook/script files: `session-start.ts`, `post-tool-use.ts`
- CamelCase for core modules: `mind.ts`
- Kebab-case for utilities: `memvid-lock.ts`, `helpers.ts`
- Test files: `*.test.ts` suffix

**Directories:**
- Lowercase, kebab-case: `src/core/`, `src/hooks/`, `src/utils/`
- Plural for collections: `hooks/`, `scripts/`, `utils/`

**Classes:**
- PascalCase: `Mind`
- Singleton accessor: `getMind()`, `resetMind()`

**Functions:**
- CamelCase: `remember()`, `getContext()`, `compressToolOutput()`
- Verb-based: `generateId()`, `extractKeyInfo()`, `classifyObservationType()`

**Types/Interfaces:**
- PascalCase: `Observation`, `MindConfig`, `HookInput`
- Suffixes: `*Type` for unions, `*Config` for configuration

## Where to Add New Code

**New Hook:**
- Implementation: `src/hooks/{hook-name}.ts`
- Registration: Add entry to `src/hooks/hooks.json`
- Build: Entry point in `tsup.config.ts` under `hooks/` key
- Pattern: Use `readStdin()`, `writeOutput()`, `debug()` helpers

**New Script:**
- Implementation: `src/scripts/{script-name}.ts`
- Build: Entry point in `tsup.config.ts` under `scripts/` key
- Documentation: Add `commands/{script-name}.md` if user-facing
- Pattern: Use `openMemorySafely()` from `src/scripts/utils.ts`

**New Utility Function:**
- Location: `src/utils/{module-name}.ts` or add to existing module
- Export: Add to `src/index.ts` if public API
- Pattern: Pure functions, no side effects where possible

**New Type:**
- Location: `src/types.ts`
- Export: Add to `src/index.ts` type exports
- Pattern: Use interfaces for objects, type aliases for unions

**New Test:**
- Location: `src/__tests__/{module-name}.test.ts`
- Framework: Vitest (import from `vitest`)
- Pattern: `describe()` blocks, `it()` or `test()` cases

## Special Directories

**dist/:**
- Purpose: Compiled output directory
- Generated: Yes (via `npm run build`)
- Committed: Yes (required for plugin distribution)
- Structure mirrors `src/` but with `.js` files

**.claude-plugin/:**
- Purpose: Plugin metadata for Claude Code marketplace
- Generated: No (manually maintained)
- Committed: Yes
- Contains: `plugin.json`, `marketplace.json`

**node_modules/:**
- Purpose: npm dependencies
- Generated: Yes (via `npm install`)
- Committed: No (in `.gitignore`)

**.install-version:**
- Purpose: Marker file for smart-install hook
- Generated: Yes (by `smart-install.ts`)
- Committed: No (in `.gitignore`)

## Build Output Structure

```
dist/
├── hooks/
│   ├── hooks.json              # Copied from src/hooks/
│   ├── smart-install.js        # Compiled hook
│   ├── session-start.js
│   ├── post-tool-use.js
│   └── stop.js
├── scripts/
│   ├── ask.js                  # Compiled scripts
│   ├── find.js
│   ├── stats.js
│   └── timeline.js
├── index.js                    # Main library entry
└── index.d.ts                  # Type definitions
```

**Build Process:**
- `tsup` compiles TypeScript to ESM format
- `hooks.json` copied via build script (`cp src/hooks/hooks.json dist/hooks/`)
- Source maps generated (`.js.map` files)
- Type definitions generated (`index.d.ts`)

---

*Structure analysis: 2026-02-03*
